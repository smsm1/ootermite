#!/usr/bin/bash -x
umask 2
CWSNAME=$1
BUILDER=$2
BUILDNO=$3
cd ..
echo "Building..."
. ./solar.env

# hack ause
export WITH_LANG="en-US de"

cd $SRC_ROOT/instsetoo_native
$PERL $SOLARENV/bin/build.pl --all -P4 -- -P2
RETVAL=$?
if [ $RETVAL -eq 0 ]; then
  $PERL $SOLARENV/bin/deliver.pl
  RETVAL=$?
  if [ $RETVAL -eq 0 ]; then
    cd $SRC_ROOT/instset_native
    $PERL $SOLARENV/bin/build.pl --all -P4 -- -P2
    RETVAL=$?
    if [ $RETVAL -eq 0 ]; then
      $PERL $SOLARENV/bin/deliver.pl
      RETVAL=$?
    fi
  fi
fi

# Sending mail to CWS owner
STATUS="[UNKNOWN]"
if [ $RETVAL -eq 0 ]; then
  STATUS="[SUCCESS]";
else
  STATUS="[FAILED]";
fi
USERNAME=$(cws query owner | tail -1)
MACHINE=$(uname -a)
SUBJECT="StarOffice Buildbot: build of $CWSNAME finished with status $STATUS"
echo "$MACHINE ($BUILDER) has finished build of your CWS $CWSNAME with status $STATUS" > mail.tmp
echo "" >> mail.tmp
echo "Visit http://so-berlin:8080/builders/$BUILDER/builds/$BUILDNO for output logs." >> mail.tmp
echo "" >> mail.tmp
echo "If you discover any problems with the Buildbot machines contact Team Tools & RelEng." >> mail.tmp
echo "" >> mail.tmp
echo "Thank you for using our StarOffice Buildbots :-)" >> mail.tmp

if [ "" != "$USERNAME" ]; then
  mail -s "$SUBJECT" $USERNAME < mail.tmp
else
  echo "cws query for email address failed!"
fi

exit $RETVAL
